<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Monitoring: Monitoring</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Monitoring
   &#160;<span id="projectnumber">3.3.4</span>
   </div>
   <div id="projectbrief">O2 Monitoring library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Monitoring </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://travis-ci.com/AliceO2Group/Monitoring"></a> <a href="https://alisw.cern.ch/dashboard/d/000000001/main-dashboard?orgId=1&amp;var-storagename=All&amp;var-reponame=All&amp;var-checkname=build%2FMonitoring%2Fo2-dataflow%2F0&amp;var-upthreshold=30m&amp;var-minuptime=30"></a> <a href="https://codecov.io/gh/AliceO2Group/Monitoring"></a> <a href="https://alice.its.cern.ch/jira/projects/OMON"></a> <a href="https://aliceo2group.github.io/Monitoring/"></a></p>
<p>Monitoring module injects user custom metrics and monitors the process. It supports multiple backends, protocols and data formats.</p>
<h2>Table of contents</h2>
<ol type="1">
<li><a href="#installation">Installation</a></li>
<li><a href="#getting-started">Getting started</a></li>
<li><a href="#advanced-features">Advanced features</a></li>
<li><a href="#system-monitoring-server-side-backends-installation-and-configuration">System monitoring and server-side backends installation and configuration</a></li>
</ol>
<h2>Installation</h2>
<p><b><a href="https://alice-doc.github.io/alice-analysis-tutorial/building/">Click here if you don't have aliBuild installed</a></b> <br />
</p>
<ul>
<li>Compile <code>Monitoring</code> and its dependencies via <code>aliBuild</code> <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;aliBuild build Monitoring --defaults o2-dataflow</div></div><!-- fragment --></li>
<li>Load the environment for Monitoring (in the <code>alice</code> directory) <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;alienv load Monitoring/latest</div></div><!-- fragment --></li>
</ul>
<h2>Getting started</h2>
<h3>Monitoring instance</h3>
<p><code>Get</code> an instance from <code>MonitoringFactory</code> by passing backend's URI(s) as a parameter (comma separated if more than one). The factory is accessible from <code><a class="el" href="namespaceo2_1_1monitoring.html" title="ALICE O2 Monitoring system. ">o2::monitoring</a></code> namespace.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="MonitoringFactory_8h.html">MonitoringFactory.h</a>&gt;</span></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceo2_1_1monitoring.html">o2::monitoring</a>;</div><div class="line">std::unique_ptr&lt;Monitoring&gt; monitoring = <a class="code" href="classo2_1_1monitoring_1_1MonitoringFactory.html#a9ce3c7abf17726e38e5353f1fde13945">MonitoringFactory::Get</a>(<span class="stringliteral">&quot;backend[-protocol]://host:port[/verbosity][?query]&quot;</span>);</div></div><!-- fragment --><p>See the table below to find <code>URI</code>s for supported backends:</p>
<table class="doxtable">
<tr>
<th>Backend name </th><th align="center">Transport </th><th align="center">URI backend[-protocol] </th><th align="center">URI query </th><th align="right">Default verbosity  </th></tr>
<tr>
<td>No-op </td><td align="center">- </td><td align="center"><code>no-op</code> </td><td align="center">- </td><td align="right">- </td></tr>
<tr>
<td>InfluxDB </td><td align="center">UDP </td><td align="center"><code>influxdb-udp</code> </td><td align="center">- </td><td align="right"><code>info</code> </td></tr>
<tr>
<td>InfluxDB </td><td align="center">Unix socket </td><td align="center"><code>influxdb-unix</code> </td><td align="center">- </td><td align="right"><code>info</code> </td></tr>
<tr>
<td>InfluxDB </td><td align="center">StdOut </td><td align="center"><code>influxdb-stdout</code> </td><td align="center">- </td><td align="right"><code>info</code> </td></tr>
<tr>
<td>InfluxDB </td><td align="center">Kafka </td><td align="center"><code>influxdb-kafka</code> </td><td align="center">Kafka topic </td><td align="right"><code>info</code> </td></tr>
<tr>
<td>InfluxDB 2.x </td><td align="center">HTTP </td><td align="center"><code>influxdbv2</code> </td><td align="center"><code>org=ORG&amp;bucket=BUCKET&amp;token=TOKEN</code> </td><td align="right"><code>info</code> </td></tr>
<tr>
<td>ApMon </td><td align="center">UDP </td><td align="center"><code>apmon</code> </td><td align="center">- </td><td align="right"><code>info</code> </td></tr>
<tr>
<td>StdOut </td><td align="center">- </td><td align="center"><code>stdout</code>, <code>infologger</code> </td><td align="center">[Prefix] </td><td align="right"><code>debug</code> </td></tr>
</table>
<h3>Metrics</h3>
<p>A metric consist of 5 parameters:</p><ul>
<li>name - metric name</li>
<li>values - vector of value and value name pairs</li>
<li>timestamp - time of creation</li>
<li>verbosity - metric "severity"</li>
<li>tags - metric metadata represented as map</li>
</ul>
<table class="doxtable">
<tr>
<th>Parameter name </th><th align="center">Type </th><th align="center">Required </th><th align="right">Default  </th></tr>
<tr>
<td>name </td><td align="center">string </td><td align="center">yes </td><td align="right">- </td></tr>
<tr>
<td>values </td><td align="center">map&lt;string, int/double/string/uint64_t&gt; </td><td align="center">no/1 </td><td align="right">- </td></tr>
<tr>
<td>timestamp </td><td align="center">time_point&lt;system_clock&gt; </td><td align="center">no </td><td align="right">current time </td></tr>
<tr>
<td>verbosity </td><td align="center">Enum (Debug/Info/Prod) </td><td align="center">no </td><td align="right">Verbosity::Info </td></tr>
<tr>
<td>tags </td><td align="center">map </td><td align="center">no </td><td align="right">host and process names </td></tr>
</table>
<p>A metric can be constructed by providing required parameters (value and metric name, value name is set to <code>value</code>): </p><div class="fragment"><div class="line">Metric{10, <span class="stringliteral">&quot;name&quot;</span>}</div></div><!-- fragment --> <h4>Values</h4>
<p>By default metric can be created with zero or one value (in such case value name is set to <code>value</code>). Any additional value may be added using <code>.addValue</code> method, therefore the following two metrics are identical: </p><div class="fragment"><div class="line">Metric{10, <span class="stringliteral">&quot;name&quot;</span>}</div><div class="line">Metric{<span class="stringliteral">&quot;name&quot;</span>}.addValue(10, <span class="stringliteral">&quot;value&quot;</span>)</div></div><!-- fragment --><h4>Tags</h4>
<p>Each metric can be tagged with any number of <a href="include/Monitoring/Tags.h">predefined tags</a>. In order to do so use <code>addTag(tags::Key, tags::Value)</code> or <code>addTag(tags::Key, unsigned short)</code> methods. The latter method allows assigning numeric value to a tag.</p>
<div class="fragment"><div class="line">Metric{10, <span class="stringliteral">&quot;name&quot;</span>}.addTag(tags::Key::Subsystem, tags::Value::QC)</div></div><!-- fragment --><p>See the example: <a href="examples/2-TaggedMetrics.cxx">examples/2-TaggedMetrics.cxx</a>.</p>
<h3>Sending metric</h3>
<p>Pass metric object to <code>send</code> method as l-value reference: </p><div class="fragment"><div class="line">send({10, <span class="stringliteral">&quot;name&quot;</span>})</div><div class="line">send(Metric{20, <span class="stringliteral">&quot;name&quot;</span>}.addTag(tags::Key::CRU, 123))</div><div class="line">send(Metric{<span class="stringliteral">&quot;throughput&quot;</span>}.addValue(100, <span class="stringliteral">&quot;tx&quot;</span>).addValue(200, <span class="stringliteral">&quot;rx&quot;</span>))</div></div><!-- fragment --><p>See how it works in the example: <a href="examples/1-Basic.cxx">examples/1-Basic.cxx</a>.</p>
<h2>Advanced features</h2>
<h3>Metric verbosity</h3>
<p>There are 3 verbosity levels (the same as for backends): Debug, Info, Prod. By default it is set to <code>Verbosity::Info</code>. The default value can be overwritten using: <code>Metric::setDefaultVerbosity(verbosity)</code>. To overwrite verbosity on per metric basis use third, optional parameter to metric constructor: </p><div class="fragment"><div class="line">Metric{10, <span class="stringliteral">&quot;name&quot;</span>, Verbosity::Prod}</div></div><!-- fragment --><p>Metrics need to match backends verbosity in order to be sent, eg. backend with <code>/info</code> verbosity will accept <code>Info</code> and <code>Prod</code> metrics only.</p>
<h3>Buffering metrics</h3>
<p>In order to avoid sending each metric separately, metrics can be temporary stored in the buffer and flushed at the most convenient moment. This feature can be controlled with following two methods: </p><div class="fragment"><div class="line">monitoring-&gt;enableBuffering(<span class="keyword">const</span> std::size_t maxSize)</div><div class="line">...</div><div class="line">monitoring-&gt;flushBuffer();</div></div><!-- fragment --><p><code>enableBuffering</code> takes maximum buffer size as its parameter. The buffer gets full all values are flushed automatically.</p>
<p>See how it works in the example: <a href="examples/10-Buffering.cxx">examples/10-Buffering.cxx</a>.</p>
<h3>Calculating derived values</h3>
<p>This feature can calculate derived values. To do so, use optional <code>DerivedMetricMode mode</code> parameter of <code>send</code> method: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;send(Metric&amp;&amp; metric, [DerivedMetricMode mode])</div></div><!-- fragment --><p>Two modes are available:</p><ul>
<li><code>DerivedMetricMode::RATE</code> - rate between two following values,</li>
<li><code>DerivedMetricMode::INCREMENT</code> - sum of all passed values.</li>
</ul>
<p>The derived value is generated only from the first value of the metric and it is added to the same metric with the value name suffixed with <code>_rate</code>, <code>_increment</code> accordingly.</p>
<p>See how it works in the example: <a href="examples/4-RateDerivedMetric.cxx">examples/4-RateDerivedMetric.cxx</a>.</p>
<h3>Global tags</h3>
<p>Global tags are added to each metric sent using given monitoring instance. <code>hostname</code> is set as global by default.</p>
<p>You can add your own global tag by calling <code>addGlobalTag(std::string_view key, std::string_view value)</code> or <code>addGlobalTag(tags::Key, tags::Value)</code>.</p>
<h3>Process monitoring</h3>
<p>This feature provides basic performance status of the process. Note that is runs in separate thread (without mutex).</p>
<div class="fragment"><div class="line">enableProcessMonitoring([interval in seconds]);</div></div><!-- fragment --><p> Following metrics are generated every time interval: CPU measurements:</p><ul>
<li><b>cpuUsedPercentage</b> - percentage of a core usage (kernel + user mode) over time interval</li>
<li><b>involuntaryContextSwitches</b> - involuntary context switches over time interval</li>
<li><b>cpuUsedAbsolute</b> - amount of time spent on process execution (in user and kernel mode) over time interval (expressed in microseconds)</li>
</ul>
<p>Memory measurements: (Linux only)</p><ul>
<li><b>memoryUsagePercentage</b> - ratio of the process's virtual memory to memory available on the machine</li>
<li><b>virtualMemorySize</b> - virtual memory reserved by process (expressed in kB)</li>
<li><b>residentSetSize</b> - resident set size reserved by process (expressed in kB)</li>
</ul>
<p>Additional metrics are generated at the end of process execution: CPU measurements:</p><ul>
<li><b>cpuTimeConsumedByProcess</b> - total amount of time spent on process execution (in user and kernel mode) (expressed in microseconds)</li>
<li><b>averageCpuUsedPercentage</b> - average percentage of a core usage over time interval</li>
</ul>
<p>Memory measurements: (Linux only)</p><ul>
<li><b>averageResidentSetSize</b> - average resident set size used by process (expressed in kB)</li>
<li><b>averageVirtualMemorySize</b> - average virtual memory used by process (expressed in kB)</li>
</ul>
<p>### StdOut backend output format </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[METRIC] &lt;name&gt;,&lt;type&gt; &lt;values&gt; &lt;timestamp&gt; &lt;tags&gt;</div></div><!-- fragment --><p> The prefix (<code>[METRIC]</code>) can be changed using query component.</p>
<h3>Regex verbosity policy</h3>
<p>Overwrite metric verbosity using regex expression: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;Metric::setVerbosityPolicy(Verbosity verbosity, const std::regex&amp; regex)</div></div><!-- fragment --><h2>System monitoring, server-side backends installation and configuration</h2>
<p>This guide explains manual installation. For <code>ansible</code> deployment see <a href="https://gitlab.cern.ch/AliceO2Group/system-configuration/tree/master/ansible">AliceO2Group/system-configuration</a> gitlab repo. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
